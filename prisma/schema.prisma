// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --------------------- User ---------------------
model User {
  id               String       @id @default(uuid())
  telegramId       String       @unique
  username         String
  role             Role         @default(USER)
  sellerStatus     SellerStatus @default(NONE)
  suspensionReason String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  sellerProfile SellerProfile?
  interactions  Interaction[]
  reportsMade   Report[]       @relation("UserReports")
  follows       Follow[]
  reviews       Review[]
  productImages ProductImage[] // Added relation to ProductImage

  @@index([telegramId])
}

// --------------------- Seller Profile ---------------------
model SellerProfile {
  id     String @id @default(uuid())
  userId String @unique

  studentId  String @unique
  campusLocation     String
  verificationStatus SellerStatuses     @default(PENDING)
  verificationScore  Int?
  verificationLevel  VerificationLevel?
  frontImageHash     String
  backImageHash      String
  verificationReason String?
  mainPhone          String
  secondaryPhone     String?

  telegram        String?
  instagram       String?
  tiktok          String?
  other           String[]
  agreedToRules Boolean      @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  shop            Shop?
  notifications   Notification[]
  interactions    Interaction[]
  reportsReceived Report[]       @relation("SellerReports")
  monthlyStats    MonthlyStats?
  followers       Follow[]       @relation("SellerProfileFollowers")

  user User @relation(fields: [userId], references: [id])

}

enum VerificationLevel {
  BASIC
  VERIFIED
  FLAGGED
}

enum SellerStatuses {
  PENDING
  APPROVED
  FLAGGED
}



// --------------------- Shop ---------------------
model Shop {
  id         String  @id @default(uuid())
  sellerId   String  @unique
  shopName   String
  categoryId String
  bio        String

  isOpen    Boolean   @default(true)
  rating    Float     @default(0) // average across all products
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  seller    SellerProfile @relation(fields: [sellerId], references: [id])
  products  Product[]
  followers Follow[]

  createdAt DateTime @default(now())

  @@index([sellerId])
  @@index([isOpen])
}

// --------------------- Category ---------------------
model Category {
  id   String  @id @default(uuid())
  name String  @unique
  icon String?

  products Product[]

  @@index([name])
}

// --------------------- Product ---------------------
model Product {
  id          String @id @default(uuid())
  name        String
  description String
  price       Float
  stock       Int?

  categoryId String
  shopId     String

  isActive Boolean @default(true)
  varified Boolean @default(false)

  status ImageStatus @default(PENDING)

  category Category @relation(fields: [categoryId], references: [id])
  shop     Shop     @relation(fields: [shopId], references: [id])

  images  ProductImage[]
  reviews Review[]

  createdAt DateTime @default(now())

  @@index([shopId])
  @@index([categoryId])
}

// --------------------- Product Images ---------------------
model ProductImage {
  id          String      @id @default(uuid())
  productId   String
  userId      String
  imagePath   String
  phash       String
  score       Int
  status      ImageStatus
  reviewed    Boolean     @default(false)
  reasons     String[]
  cameraMake  String?
  cameraModel String?
  createdAt   DateTime    @default(now())

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([userId])
  @@index([phash])
  @@index([status])
}

enum ImageStatus {
  APPROVED
  PENDING
  REVIEW
  REJECTED
}

// --------------------- Report ---------------------
model Report {
  id        String   @id @default(uuid())
  reason    String
  createdAt DateTime @default(now())

  reporterId String
  sellerId   String

  reporter User          @relation("UserReports", fields: [reporterId], references: [id])
  seller   SellerProfile @relation("SellerReports", fields: [sellerId], references: [id])

  @@index([sellerId])
  @@index([reporterId])
  @@index([createdAt])
}

// --------------------- Interaction ---------------------
model Interaction {
  id        String          @id @default(uuid())
  action    InteractionType
  createdAt DateTime        @default(now())

  userId          String?
  sellerProfileId String

  user          User?         @relation(fields: [userId], references: [id])
  sellerProfile SellerProfile @relation(fields: [sellerProfileId], references: [id])

  @@index([sellerProfileId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// --------------------- Notification ---------------------
model Notification {
  id        String           @id @default(uuid())
  message   String
  type      NotificationType
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  sellerProfileId String
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id])

  @@index([sellerProfileId])
  @@index([type])
  @@index([createdAt])
}

// --------------------- Monthly Stats ---------------------
model MonthlyStats {
  id                String @id @default(uuid())
  month             Int // 1-12
  year              Int
  followersGained   Int    @default(0)
  reportsCount      Int    @default(0)
  contactClicks     Int    @default(0)
  socialMediaChecks Int    @default(0)

  sellerProfileId String        @unique
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id])

  @@index([month, year])
}


// --------------------- Follow ---------------------
model Follow {
  id              String   @id @default(uuid())
  userId          String
  shopId          String
  sellerProfileId String
  createdAt       DateTime @default(now())

  user          User          @relation(fields: [userId], references: [id])
  shop          Shop          @relation(fields: [shopId], references: [id])
  sellerProfile SellerProfile @relation("SellerProfileFollowers", fields: [sellerProfileId], references: [id])

  @@unique([userId, shopId])
  @@index([shopId])
  @@index([userId])
  @@index([createdAt])
  @@index([sellerProfileId])
}

// --------------------- Review ---------------------
model Review {
  id        String   @id @default(uuid())
  userId    String
  productId String
  rating    Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId]) // one review per product per user
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

// --------------------- Enums ---------------------
enum Role {
  USER
  SELLER
  BOTH
}

enum SellerStatus {
  NONE
  APPROVED
  SUSPENDED
}

enum InteractionType {
  CONTACT_CLICK
  SOCIAL_MEDIA_CHECK
  REPORT
  FOLLOW
}

enum NotificationType {
  REPORT
  INTERACTION
  WARNING
  INFO
}
